---
import Layout from "../../layouts/Layout.astro";
---
<Layout>
  <h1>ðŸš— Cars - Multi-Filtres</h1>
  
  <div style="margin: 20px 0; display: flex; gap: 20px; flex-wrap: wrap;">
    <div>
      <label for="cylinders">Cylindres :</label>
      <select id="cylinders">
        <option value="">Tous</option>
        <option value="4">4</option>
        <option value="6">6</option>
        <option value="8">8</option>
      </select>
    </div>
    
    <div>
      <label for="year">AnnÃ©e :</label>
      <select id="year">
        <option value="">Toutes</option>
        <option value="70">70</option>
        <option value="71">71</option>
        <option value="72">72</option>
        <option value="73">73</option>
        <option value="78">78</option>
        <option value="79">79</option>
        <option value="80">80</option>
        <option value="82">82</option>
      </select>
    </div>
    
    <div>
      <label for="power">Puissance (hp) :</label>
      <select id="power">
        <option value="">Toutes</option>
        <option value="90">90</option>
        <option value="97">97</option>
        <option value="100">100</option>
        <option value="110">110</option>
        <option value="120">120</option>
        <option value="150">150</option>
        <option value="175">175</option>
        <option value="190">190</option>
      </select>
    </div>
  </div>
  
  <div id="carplot"></div>
  
  <div id="stats" style="margin-top: 20px; padding: 10px; background-color: #f5f5f5; border-radius: 5px;">
    <p>Voitures affichÃ©es : <strong id="count">0</strong></p>
  </div>

  <script>
    import * as Plot from "https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6/+esm";
    import cars from "../../assets/cars.json";
    
    const selectCylinders = document.querySelector("#cylinders") as HTMLSelectElement;
    const selectYear = document.querySelector("#year") as HTMLSelectElement;
    const selectPower = document.querySelector("#power") as HTMLSelectElement;
    const countSpan = document.querySelector("#count");
    
    function renderPlot() {
      if (!selectCylinders || !selectYear || !selectPower) return;
      
      const cyl = selectCylinders.value;
      const year = selectYear.value;
      const power = selectPower.value;
      
      const plotDiv = document.querySelector("#carplot");
      if (!plotDiv) return;
      plotDiv.innerHTML = "";
      
      let filteredCars = cars.filter(c => c["power (hp)"] != null && c["economy (mpg)"] != null);
      if (cyl) filteredCars = filteredCars.filter(c => String(c.cylinders) === cyl);
      if (year) filteredCars = filteredCars.filter(c => String(c.year) === year);
      if (power) filteredCars = filteredCars.filter(c => String(c["power (hp)"]) === power);
      
      if (countSpan) countSpan.textContent = filteredCars.length.toString();
      if (filteredCars.length === 0) return;
      
      const plot = Plot.plot({
        marks: [
          Plot.dot(filteredCars, {
            x: "power (hp)",
            y: "economy (mpg)",
            fill: (d: any) => String(d.cylinders),  // couleur par nombre de cylindres
            r: 3,
            opacity: 0.7,
          }),
        ],
        color: { legend: true },
        grid: true,
      });
      
      plotDiv.append(plot);
    }
    
    [selectCylinders, selectYear, selectPower].forEach(el => el.addEventListener("change", renderPlot));
    renderPlot();
  </script>
</Layout>
